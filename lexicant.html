<html>

<head>
  <title>Lexicant game</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700">
  <link rel="stylesheet" href="/style.css" type="text/css">

  <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>   
</head>
<body>
    <h1>Lexicant game</h1>
    </br>
    <div id="gameBoard">
      <input autoFocus="true" maxLength=1 type="text" id="prepend" class="gameBoardLetter">
      <input maxLength=1 type="text" id="append" class="gameBoardLetter">
    </div>
    <button id="undoButton">Undo</button>
    <button id="hintsButton">Hints</button>
    <button id="challengeButton">Challenge</button>
    <div id="message"></div>
    <div>Words played this session:<pre id="playedWords">[]</pre></div>
</body>

<script src="/LetterBitMapTrie.js"></script>

<script type="text/babel">
    const prepend = document.getElementById("prepend")
    const append = document.getElementById("append")
    let letters = ""
    const lettersUI = document.getElementById("gameBoard")
    let lettersState = []
    const undoButton = document.getElementById("undoButton")
    const hintsButton = document.getElementById("hintsButton")
    const challengeButton = document.getElementById("challengeButton")
    const message = document.getElementById("message")

    let dictionary = new Set()
    let trie = null

    const playedWordsUI = document.getElementById("playedWords")
    const playedWords = []
    
    let url = new URL(window.location);
    if (url.searchParams.has('sequence')) {
      lettersState = url.searchParams.get('sequence').split('').map((x) => [x, false])
      letters = url.searchParams.get('sequence')
      refreshLettersUI()
    }

    async function getDictionary() {
        const response = await fetch("/dictionary.json")
        return await response.json()
    }

    getDictionary().then(doMoreJavascript)

    function doMoreJavascript(dict) {
        dictionary = new Set(dict.filter(word => word.length > 3))
        trie = new LetterBitMapTrie(dictionary)
        showHints()
    }

    function prependLetter(event) {
      updateLetters("front", event.target.value)
      prepend.value = ""
    }

    function appendLetter(event) {
      updateLetters("end", event.target.value)
      append.value = ""
    }

    function undo() {
      updateLettersState("pop")
      updateLettersState("pop")
      url.searchParams.set("sequence", letters)
      history.pushState({}, "", url)
      showHints()
    }

    function refreshLettersUI() {
      lettersUI.innerHTML = Array.from(letters).map(letter => `<div class="gameBoardLetter">${letter}</div>`).join("")
      lettersUI.prepend(prepend)
      lettersUI.append(append)
      prepend.value = ""
      append.value = ""
    }
    
    function updateLettersState(mode, char = null) {
      if (mode === "end") {
        lettersState.push([char, false]) 
        letters += char
      } else if (mode === "front") {
        lettersState.push([char, true]) 
        letters = char + letters
      } else if (mode === "pop") {
        let arr = lettersState.pop()
        if (arr[1]) {
          letters = letters.substring(1)
        } else {
          letters = letters.substring(0, letters.length - 1)
        }
      }

      refreshLettersUI();
    }

    function updateLetters(mode, char = null) {
      message.innerHTML = ""
      if (char !== null && !char.match(/[a-z]/i)) {
        if (char === " ") {
          if (document.activeElement === prepend) {
            append.focus()
          } else {
            prepend.focus()
          }
        }
        return
      }
      char = char.toLowerCase()
      updateLettersState(mode, char)
      // TODO: just use the letters variable instead of word
      const word = letters
      if (dictionary.has(word)) {
         message.innerHTML = word + " is in the dictionary, you lost"
         resetGame(word)
      } else {
        let apps = trie.append().get(word)
        let preps = trie.prepend().get(word)
        let winning_appends = apps.filter(
          letter => trie.perfectPlay(word + letter) === 1)

        let winning_prepends = preps.filter(
          letter => trie.perfectPlay(letter + word) === 1)
        //message.innerHTML = preps + "<br>" + apps + "<br>" + 
        //  winning_appends + "<br>" + winning_prepends

        let safe_appends = apps.filter(
          letter => !dictionary.has(word + letter))
        let safe_prepends = preps.filter(
          letter => !dictionary.has(letter + word))

        if (winning_appends.length !== 0 &&
            (winning_prepends.length === 0 || Math.random() > .5)) {
          let move = randomChoice(winning_appends)
          computerAppend(move)
          showHints()
        } else if (winning_prepends.length !== 0) {
          let move = randomChoice(winning_prepends)
          computerPrepend(move)
          showHints()
        } else if (safe_appends.length !== 0 &&
            (safe_prepends.length === 0 || Math.random() > .5)) {
          let move = randomChoice(safe_appends)
          computerAppend(move)
          showHints()
        } else if (safe_prepends.length !== 0) {
          let move = randomChoice(safe_prepends)
          computerPrepend(move)
          showHints()
        } else if (apps.length !== 0 &&
          (preps.length === 0 || Math.random() > .5)) {
          let move = randomChoice(apps)
          computerAppend(move)
          if (dictionary.has(word + move)) {
            message.innerHTML = `Word is ${word + move}. Computer loses!`
            resetWord()
          } else {
            showHints()
          }
        } else if (preps.length !== 0) {
          let move = randomChoice(preps)
          computerPrepend(move)
          if (dictionary.has(move + word)) {
            message.innerHTML = `Word is ${move + word}. Computer loses!`
            resetWord()
          } else {
            showHints()
          }
        } else {
          message.innerHTML = word + ": computer challenges you! There's no valid continuation"
          resetGame(word)
        }
      }
      url.searchParams.set("sequence", letters)
      history.pushState({}, "", url)
    }

    function computerPrepend(letter) {
      updateLettersState("front", letter)
    }

    function computerAppend(letter) {
      updateLettersState("end", letter)
    }

    function showHints(force = false) {
      if (!force && !url.searchParams.get("hints")) {
        return
      }
      // TODO: just use the letters variable instead of word
      const word = letters
      let apps = trie.append().get(word)
      let preps = trie.prepend().get(word)
      let winning_appends = apps.filter(
        letter => trie.perfectPlay(word + letter) === 1)

      let winning_prepends = preps.filter(
        letter => trie.perfectPlay(letter + word) === 1)
      
      let safe_appends = apps.filter(
        letter => !dictionary.has(word + letter))
      let safe_prepends = preps.filter(
        letter => !dictionary.has(letter + word))

      message.innerHTML =
        "valid prepends: " + preps + "<br>" +
        "valid appends: " + apps + "<br>" +
        "winning prepends: " + winning_prepends + "<br>" +
        "winning appends: " + winning_appends + "<br>" +
        "safe prepends: " + safe_prepends + "<br>" +
        "safe appends: " + safe_appends + "<br>"
    }

    function resetGame(endingWord) {
      playedWords.push(endingWord);
      playedWordsUI.innerText = JSON.stringify(playedWords, null, 2)

      letters = ""
      lettersState = []
      refreshLettersUI()
    }

    function respondToChallenge() {
      while (!dictionary.has(letters)) {
        let apps = trie.append().get(letters)
        let preps = trie.prepend().get(letters)
        let index = Math.floor(Math.random() * (apps.length + preps.length))
        if (index < apps.length) {
          computerAppend(apps[index])
        } else {
          computerPrepend(preps[index - apps.length])
        }
      }
      message.innerHTML = `I was thinking of \"${letters}\"!`
      resetGame(letters)
    }

    function randomChoice(list) {
        return list[Math.floor(Math.random()*list.length)]
    }

    prepend.oninput = prependLetter
    append.oninput = appendLetter
    undoButton.onclick = undo
    hintsButton.onclick = function() { showHints(true) }
    challengeButton.onclick = respondToChallenge
</script>
